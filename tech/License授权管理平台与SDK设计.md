# License授权管理平台与SDK架构设计思路

对于软件类产品，无论时2B，还是2C，大部分都会涉及到License的授权问题，怎么设计实现安全易用的授权是一个比较通用的需求。

## 1. 我们的场景

我们公司为企业提供算法和模型的服务，形态通常都是以软件的形式提供，交付给客户的通常算法API接口，或者一整套囊括业务在内的平台，这就要求我们的授权平台除了安全和绑定机器之外，还应该支持：

1. 不同的产品能够方便的进行接入，尽量简化接入工作，最好能够做到算法工程师也能比较容易的接入；
2. 比较方便的授权管理，例如更新授权，最好是商务同事根据我们的操作指引就能自己给客户更新授权，尽可能降级技术门槛。

## 2. 设计思路

- 对于第一点，需要实现一个客户端接入SDK，把硬件指纹校验和有效期校验等直接封装到SDK里，客户端则只需要调用SDK即可。
- 对于第二点，则需要实现一个授权管理平台，商务或者产品的同事，只需要在平台上下载新的License文件到指定位置即可。

只要实现这两点，一个授权管理平台就算达到了目的。

## 3. 公钥和私钥体系

简单的密钥场景是这样的，就像一把锁，如果想要某人能够开这把锁，那就只能给他一把钥匙。这对于一把锁来说，可能已经够了，可是对于互联网来说却是不太够的，如果密钥在传输过程中泄露了怎么办？如果我把密钥传给了你，你用来伪造数据怎么办？

而公钥私钥算法就没有这方面的烦恼了，在这个体系下，如果我要给你发信息，我就用自己的私钥加密信息，然后将加密的信息传给你，你则用我给你的公钥进行解密。在这个过程中，即使有人截获了传输的信息，他也没法伪造，因为私钥只有我自己有。当然，如果你的公钥泄密了，别人也能获取信息的内容，但是即使这样他也没法进行伪造。这样就能保证你能接收到正确的信息。

对于我们这个授权管理平台关联三个实体：服务器，客户端，客户端SDK。这三个实体各自都有一套公钥和私钥，例如客户端SDK，自己保留私钥，公钥可以放到服务器或者客户端上。

### 3.1 安全的接口调用

例如客户端在调用SDK时，为保证安全，需要做到以下几点：

1. **调用是否真的来自客户端**：客户端可以使用SDK公钥将参数加密后，再传给SDK，如果没有加密的话，别人就可以模拟这个调用来获取返回值；
2. **被调用的SDK是否被篡改**：这个可以通过SDK的文件编码进行校验，如果没有这个校验，别人就能实现一个代理，来截获传输的内容，或者绕开硬件指纹校验；
3. **返回信息是否加密**：没加密的话，则有可能被人截获。

如果保证了这三点，通信基本上是安全的了，只要私钥没有泄露。（通过反编译，私钥也是可能会泄露的）

## 4. 整体架构设计思路

![架构图](/_img/license.png)

开发过程：

1. 使用硬件指纹采集模块，生成硬件指纹文件，并上传到授权管理平台。
2. 授权管理平台将指纹文件和需要接入的客户端绑定在一起，自动生成一个License文件（使用公钥加密生成）。
3. 下载License文件和客户端接入SDK到客户端目录下指定的位置。
4. 根据SDK接口文档，就可以接入License校验功能了。

客户端启动过程：

1. 首先启动的是客户端主程序。
2. 加密调用SDK的校验函数，校验硬件指纹和License有效期。
3. 从SDK返回加密后的参数，客户端解密后再对参数进行校验。
4. 一切校验完成，才继续执行客户端的其他功能。

说明：

- 客户端和SDK之间的通信都是使用公钥加密过的，避免被伪造。
- 为了确保安全，还需要校验SDK本身是否被篡改了。

## 5. 设计收获

- 公钥私钥体系的理解
- 如何保证通信过程的安全性
