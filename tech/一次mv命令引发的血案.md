# 一次mv命令引发的血案

## 1. 问题的发生

昨天周五，在快下班的时候，大家正准备愉快的下班的时候，突然有同事报告说某个服务器登陆不上了。怎么就突然登陆不了了呢，有谁在操作服务器吗？
还真有，一个同事正在操作着服务器，查看他执行的命令，有一个mv命令：`sudo mv /* /home下某个目录`，问题就正在发生了。

根目录下的东西基本都基本都被移动到了这个目录下，etc, bin, lib等都未能幸免（只有少数几个目录没有被移动，例如home目录就没有被移动，应该是有些目录被其他应用程序锁定了），几乎平常所有的Linux命令都用不了了，ls都不行，看起来是没救了。ssh也没法登陆了，幸亏还有两个电脑本来就ssh连着那个服务器，只有这两个终端是可以使用的。mv和cp也用不了，sudo和su也没法用，形势不容乐观。所幸，不是`sudo rm -rf /`。

## 2. 迷茫的解决过程

虽然问题很严重，基本没有思路，大家都一筹莫展，不过问题还是得解决不是。至少看上去硬盘上的数据都没有丢，只是被移动了位置，导致命令都用不了，只要把文件都移动回去，系统可能就没事了。

忙乱中解决途径大约就两个：

1. 一边搜索引擎，一边小心的探索；
2. 同时找一些认识的人，看看有没有人有相关的经验的。

一番讨论和尝试之后，保底方案算是有了：就是去到机房，关掉服务器，取出硬盘，把他挂载到另一个计算机上，在这个计算机上就可以移动操作了。这样至少服务器的数据是可以保证的，只是要去到机房很麻烦，而且那样事件就搞得比较大了。

网上也有些同病相怜的人（不知道跑路了没），照着文章去做，好像有些眉目了，至少可以执行一些命令了，例如ls命令：

```sh
/home/ibbd/mariadb_test/data/mariadb_load_temp/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2 \
    --library-path /home/ibbd/mariadb_test/data/mariadb_load_temp/lib/x86_64-linux-gnu \
    /home/ibbd/mariadb_test/data/mariadb_load_temp/bin/ls \
    /home/ibbd/mariadb_test/data/mariadb_load_temp/etc
```

我们的常用的命令大多数都在bin目录或者usr/bin目录，但是单纯指定完整路径，也是没法执行这些命令的，得加上ld-linux的so文件，这个文件是Linux的动态加载器。当操作系统加载某个应用程序的时候，它必须找到并加载该应用程序所依赖的动态链接库，在Linux上，这个工作就是有ld-linux负责的。在正常的情况下，这些文件都在自己的路径下，系统直接就能加载了，但是目录完全改变之后，操作系统就再也找不到它们了。

ld-linux在执行的时候，可以指定库文件的路径，否则应用程序依赖的动态库也会找不到，而且这个库文件的可能路径还可能有多个。如果是多个库路径，则可以使用冒号分隔连接多个路径。通过这个方式，cp命令和mv命令也可以使用了，不过依然还是没能把文件复制回原来的地方，因为没有权限！

权限，这是个大问题。网上很多的解决方案，都是基于他们本来用的就root用户操作，不存在权限的问题。但是我们的情况却是普通用户，su命令完全不起作用，应该是/etc/passwd这类的文件都被移动走了。而sudo命令来回尝试了无数次还是没有用，有朋友说，sudo不是普通的命令，这个有待后续研究。经一些朋友的提点，下面的方式也可能的解决问题的方式：

**在root用户下执行的定时脚本**：如果有这样的脚本，则可以往里面加入我们想要执行的命令，然后等待脚本定时执行即可，不够可惜我们的系统上没有这样的“漏洞”。

看起来，权限是一个绕不过去的坎，真是密不透风。

## 3. 柳暗花明又一村

看来想通过还连着的客户端恢复是没希望了，那就备份数据（这个服务器是我们MySQL数据库集群的节点之一，也是我们es集群的节点之一，es集群我们判断增加或者删除一个节点问题不大，不过对MySQL却把握不大，毕竟对集群更改的操作做得少，虽然对MySQL是比较有信心的），然后重启，尝试进入Ubuntu恢复模式。如果这个都不行，那么就只剩下最后的保底方案了。

重启进入恢复模式之后，提示进入的是initramfs，因为我们都没有这方面的操作经验，于是一边搜索引擎，一边摸索。这个模式下，可用的命令也不多，通过help命令可以查到可以用的命令。我们平台使用的系统的文件系统，整个都在/root目录，但是只读！所以，探索下来解决方案关键的一步就是，重新挂载/root目录为可读写的权限。

居然走通了，大家一阵激动，当时凌晨3点左右，从发现问题开始时间已经过去了9个小时左右，外面呼呼的北风吹着，瑟瑟发抖。

终于不用跑到机房了。

## 4. 后记

不过数据虽然恢复了，命令也都可以用了，但是系统服务并没有完全正常，应该是移动过程中很多文件的权限可能改变了，导致es和MySQL服务都没法启动，不过这些另表。

总结一下这突发情况的处理：

1. 看似很严重的问题，其实通常都还是有解决方案的。
2. 服务器的操作权限应该要小心，特别是一些新手，或者经验不够丰富的程序员，尽量不要直接接触生产环境，一不小心可能就会搞出个大血案。万一真是`rm -rf /`，那真是可以跑路了。
3. 大家在操作服务器的时候，除了不要使用root用户（没什么特别需要，千万千万不要使用root用户），还应该尽量减少sudo的使用，很多情况其实是可以避免使用sudo的。
4. 服务器上，其实也可以对一些危险操作进行限制的，例如mv和rm等命令，只是比较麻烦。

20200110