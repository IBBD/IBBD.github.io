# æ—¥å¿—åˆ†æžä¹‹shellç¯‡

shellæ˜¯æ—¥å¿—åˆ†æžæœ€åŸºç¡€ï¼Œä¹Ÿæ˜¯æœ€å¼ºå¤§çš„å·¥å…·ä¹‹ä¸€ã€‚æœ¬æ–‡ç”¨åˆ°çš„æ ·ä¾‹æ•°æ®æ–‡ä»¶[åœ¨è¿™é‡Œ](/_img/log-sample01.log)ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```
[GIN] 2016/11/21 - 16:50:36 |[97;42m 204 [0m|     441.717Âµs | 121.69.49.144 |[97;46m  [0m POST    /bid/api
[GIN] 2016/11/21 - 16:50:36 |[97;42m 204 [0m|     773.736Âµs | 121.69.49.138 |[97;46m  [0m POST    /bid/api
[GIN] 2016/11/21 - 16:50:36 |[97;42m 200 [0m|      49.519Âµs | 121.69.49.144 |[97;44m  [0m GET     /win/api
[GIN] 2016/11/21 - 16:50:36 |[97;42m 204 [0m|     462.392Âµs | 121.69.49.139 |[97;46m  [0m POST    /bid/api
[GIN] 2016/11/21 - 16:50:36 |[97;42m 204 [0m|     503.733Âµs | 121.69.49.145 |[97;46m  [0m POST    /bid/api
[GIN] 2016/11/21 - 16:50:36 |[97;42m 204 [0m|     430.477Âµs | 121.69.49.138 |[97;46m  [0m POST    /bid/api
[GIN] 2016/11/21 - 16:50:37 |[97;42m 204 [0m|    2.462103ms | 121.69.49.138 |[97;46m  [0m POST    /bid/api
```

è¿™æ˜¯supervisorè®°å½•åˆ°çš„æŽ¥å£çš„è®¿é—®æ—¥å¿—ï¼Œå¯¹äºŽæœ¬æ–‡éœ€è¦ç”¨åˆ°çš„å­—æ®µï¼š

- æ—¥æœŸæ—¶é—´
- httpå“åº”ç ï¼šä¸»è¦æ˜¯200å’Œ204ä¸¤ç§
- å“åº”æ—¶é—´
- æŽ¥å£åœ°å€

é€šè¿‡å¯¹æ—¥å¿—çš„åˆ†æžï¼Œéœ€è¦è¾¾åˆ°ç›®æ ‡ï¼š

- ä¸åŒå“åº”ç çš„å æ¯”ï¼Œä¸»è¦å…³æ³¨é™¤200å’Œ204ä¹‹å¤–çš„å“åº”ç ï¼Œä¾‹å¦‚400ï¼Œ500ï¼Œ404ç­‰ï¼Œè¿™æ˜¯å¼‚å¸¸å¯¼è‡´çš„
- /bid/apiæŽ¥å£ä¸‹çš„200çŠ¶æ€ç çš„å¹³å‡å“åº”æ—¶é—´ï¼ŒTOP90%çš„å“åº”æ—¶é—´ï¼ŒTOP99%çš„å“åº”æ—¶é—´ï¼Œå’Œå“åº”æ—¶é—´è¶…è¿‡50msçš„å æ¯”
- ä¸åŒçŠ¶æ€ç ä¸‹çš„ç›¸åº”æ—¶é—´åˆ†å¸ƒ

## ä¸åŒå“åº”ç çš„å æ¯”

å‘½ä»¤å¦‚ä¸‹ï¼š

```sh
cat log-sample01.log|cut -d" " -f6|sort|uniq -c|sort
```

ç»“æžœå¦‚ï¼š

```
1    404
79   200
9162 204
```

æ€è·¯ï¼šå…ˆç­›é€‰éœ€è¦çš„å­—æ®µï¼Œç„¶åŽç»Ÿè®¡æŽ’åºã€‚

é¡ºåºçœ‹è¿™å‡ ä¸ªå‘½ä»¤ï¼š

- `cut -d " " -f6`: æ ¹æ®ç©ºæ ¼åˆ†å‰²å­—ç¬¦ä¸²ï¼Œå¹¶é€‰å–ä¸‹æ ‡ä¸º6çš„å­å­—ç¬¦ä¸²ï¼ˆæ³¨æ„ä¸‹æ ‡æ˜¯ä»Ž1å¼€å§‹çš„ï¼‰ï¼Œè¿™æ ·å°±å¾—åˆ°äº†çŠ¶æ€ç åˆ—è¡¨
- `sort`: å¯¹çŠ¶æ€ç åˆ—è¡¨è¿›è¡ŒæŽ’åºï¼Œè¿™æ—¶ä¸ºä¸‹ä¸€ä¸ªå‘½ä»¤å‡†å¤‡æ•°æ®
- `uniq -c`: å¯¹æ•°æ®è¿›è¡Œå”¯ä¸€æ€§ç»Ÿè®¡ï¼Œéœ€è¦å…ˆæŽ’åº
- `sort`: æœ€åŽçš„æŽ’åºæ˜¯è®©ç»“æžœæ›´åŠ æ˜Žæ˜¾ï¼Œé»˜è®¤æŒ‰ç¬¬ä¸€åˆ—è¿›è¡ŒæŽ’åºï¼Œå¦‚æžœæƒ³æŒ‰ç…§ç¬¬äºŒåˆ—æŽ’åº`sort -k2`

## bidæŽ¥å£ä¸‹200çŠ¶æ€ç çš„æ—¶é—´åˆ†å¸ƒ

ç¡®å®šè€—æ—¶çš„å•ä½æ˜¯å¦ä¸€è‡´ï¼š

```sh
grep "/bid/api" log-sample01.log|grep " 200 "|wc -l
grep "/bid/api" log-sample01.log|grep " 200 "|grep "ms |"|wc -l
```

å¦‚æžœè¿™ä¸¤ä¸ªå‘½ä»¤çš„è¾“å‡ºç»“æžœä¸€è‡´ï¼Œåˆ™è¡¨ç¤ºæ¯ä¸ªæŽ¥å£çš„è€—æ—¶çš„å•ä½éƒ½æ˜¯msã€‚è¿™é‡Œçš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨`grep`å‘½ä»¤è¿‡æ»¤ç›®æ ‡æ—¥å¿—è®°å½•ï¼Œç„¶åŽæŸ¥æ‰¾ç›¸åº”çš„ç‰¹å¾ï¼Œä¾‹å¦‚`ms |`

æœ€åŽå®Œæ•´çš„ç»Ÿè®¡å‘½ä»¤å¦‚ä¸‹ï¼š

```sh
grep "/bid/api" log-sample01.log|grep " 200 "|sed "s/\s\+/ /g"|cut -d" " -f8|cut -d. -f1|sort|uniq -c|sort -k2 -n
```

ç»“æžœå¦‚ä¸‹ï¼š

```
68 2
5  3
1  4
1  5
1  15
```

ç»“æžœæ˜¾ç¤ºï¼ŒæŽ¥è¿‘90%çš„å“åº”æ—¶é—´éƒ½åœ¨2-3æ¯«ç§’ä¹‹é—´ï¼Œéžå¸¸ä¹‹é«˜æ•ˆã€‚

è§£é‡Šä¸€ä¸‹ï¼Œåˆšæ‰çš„ç»Ÿè®¡å‘½ä»¤ï¼š

- `sed "s/\s\+/ /g"`: è¿™ä¸ªæ›¿æ¢å‘½ä»¤æ˜¯å°†å¤šä¸ªè¿žç»­çš„ç©ºæ ¼ï¼Œæ›¿æ¢ä¸ºä¸€ä¸ªç©ºæ ¼ã€‚è¿™æ˜¯å…³é”®çš„ä¸€ä¸ªæ­¥éª¤ï¼Œå®Œæˆè¿™ä¸ªæ­¥éª¤ï¼Œå°±å¯ä»¥ä½¿ç”¨`cut`å‘½ä»¤è¿›è¡Œåˆ†å‰²äº†
- `cut -d. -f1`: å› ä¸ºæˆ‘ä»¬ç»Ÿè®¡çš„æ˜¯æ—¶é—´æ®µï¼Œæ‰€ä»¥å°æ•°ç‚¹åŽé¢çš„å€¼å¯ä»¥çœç•¥
- `sort -k2 -n`: è¿™ä¸ªæŽ’åºå‘½ä»¤æ˜¯æŒ‰ç¬¬2åˆ—è¿›è¡ŒæŽ’åºï¼Œ`-n`æ˜¯æŒ‡æŒ‰æ•°å€¼è¿›è¡ŒæŽ’åº

sortå¦‚æžœéœ€è¦å€’åºï¼Œåˆ™åŠ ä¸Š`-r`å‚æ•°

--------------

çœ‹åˆ°è¿™é‡Œï¼Œåº”è¯¥èƒ½åˆæ­¥æ„Ÿå—åˆ°ä½¿ç”¨shellåšæ—¥å¿—åˆ†æžçš„å¼ºå¤§äº†ï¼Œshellçš„åŸºæœ¬å‘½ä»¤ä¸å¤šï¼Œä½†æ˜¯é€šè¿‡ç®¡é“ç»„åˆåˆ°ä¸€èµ·ï¼Œå°±èƒ½çŽ©å‡ºèŠ±æ¥ã€‚

è¿˜æœ‰æ›´å¼ºå¤§çš„å·¥å…·`awk`

## ç»å¸¸ç¢°åˆ°çš„é—®é¢˜ä¹‹ä¸€

- åœ¨windowså¤„ç†çš„æ–‡ä»¶ï¼Œç»å¸¸å‡ºçŽ°ç‰¹æ®Šç¬¦å·â€œâ€

è¿™æ˜¯ä¸€ä¸ªä¸å¯è§å­—ç¬¦ï¼Œéœ€è¦å¤„ç†æˆæ¢è¡Œç¬¦ï¼Œè€Œå®ƒçš„è¾“å…¥æ˜¯â€œctrl+v ctrl+mâ€!

æ›¿æ¢å‘½ä»¤ï¼š

```sh
cat filename.txt | tr "" "\n" > new_filename.txt
```

